{% if layout != blank %}
    {% layout layout %}
{% endif %}

<script>
    function ready() {
        // console.log(document.styleSheets);
        // console.log(document.location);
        var urlParams = new URLSearchParams(window.location.search);
        var prefix = urlParams.get('preview_mode');
        var suffix = "?preview_mode=" + prefix + "&v=" + Date();

        var nodes = document.getElementsByTagName("link");
        var head = document.getElementsByTagName("head").item(0);

        function generateLinkNode(url) {
            var result = document.createElement("link");
            result.setAttribute("rel", "stylesheet");
            result.setAttribute("type", "text/css");
            result.setAttribute("href", url);
            return result;
        }

        for (var i = 0; i < nodes.length; i++) {
            var styleSheet = nodes[i];
            if (styleSheet.href && styleSheet.href.startsWith(document.location.origin) && styleSheet.href.endsWith(".css")) {
                var url = styleSheet.href + suffix;
                var newlink = generateLinkNode(url);
                head.replaceChild(newlink, styleSheet);
            }
        }
    }

    document.addEventListener("DOMContentLoaded", ready);

    (function () {
        var renderApiUrl = "/designer-preview/";
        var designerUrl = "http://localhost:4200/";

        function getUrl(part) {
            return renderApiUrl + part;
        }

        var app = angular.module("storefrontApp");

        app.controller("previewController", ["$http", '$sce', '$scope', '$window', function ($http, $sce, $scope, $window) {
            $scope.title = "";
            $scope.blocks = []; // html strings

            $scope.selectBlock = function (item) {
                // items with id are editable, the other are under preview, so should not be send to designer
                if (item.id > 0) {
                    $window.parent.postMessage({ type: 'open', id: item.id }, designerUrl); // parent - is a designer window
                }
            };

            $window.addEventListener('message', function (event) {
                var data = event.data;
                dispatchEvent(data.type, data);
            });

            function dispatchEvent(type, data) {
                $scope.$apply(function () {
                    clearPreviewItems();
                    switch (type) {
                        case "settings":
                            reloadDocument();
                            break;
                        case "page":
                            /* data = { type: "page", content: [{}] } */
                            reloadPage(data.content);
                            break;
                        case "move":
                            var current = $scope.blocks[data.content.currentIndex];
                            $scope.blocks.splice(data.content.currentIndex, 1);
                            $scope.blocks.splice(data.content.newIndex, 0, current);
                            scrollTo(current.id);
                            break;
                        case "addOrUpdate":
                            if (!!data.content) {
                                var model = createBlockModel(data.content);
                                var exists = findById(model.id);
                                if (!exists) {
                                    $scope.blocks.push(model);
                                } else {
                                    $scope.blocks[exists.index] = model;
                                }
                                renderBlock(model, function () {
                                    scrollTo("");
                                });
                            }
                            break;
                        case "remove":
                            var exists = findById(data.content);
                            $scope.blocks.splice(exists.index, 1)
                            break;
                        case "scrollTo":
                            scrollTo(data.content.id);
                            break;
                        default:
                            console.log(type, data);
                            break;
                    }
                });
            }

            function scrollTo(itemId) {
                setTimeout(function () {
                    var id = "#block-" + itemId;
                    var el = $(id);
                    if (el.length) {
                        var targetPosition = el.offset().top - window.innerHeight / 10;
                        var currentPosition = $window.scrollY;
                        var time = Math.abs(currentPosition - targetPosition) * 300 / 1000;
                        $("#preview-container .block-holder.active").removeClass("active");
                        el.addClass("active");
                        $('html, body').animate({ scrollTop: targetPosition }, time, function () { });
                    }
                }, 400);
            }

            function reloadDocument() {
                document.location.reload();
            }

            function clearPreviewItems() {
                $("#preview-container .block-holder.active").removeClass("active");
                for (var i = 0; i < $scope.blocks.length; i++) {
                    var block = $scope.blocks[i];
                    if (!block.id) {
                        $scope.blocks.splice(i, 1)
                        i--;
                    }
                }
            }

            function reloadPage(page) {
                $scope.blocks = [];
                for (var i = 0; i < page.length; i++) {
                    if (page[i].type == 'settings') {
                        $scope.title = page[i].title;
                    } else {
                        var section = page[i];
                        var model = createBlockModel(section);
                        $scope.blocks.push(model);
                    }
                }
                renderBlocks();
            }

            var promises = [];

            function renderBlocks() {
                for (var i = 0; i < $scope.blocks.length; i++) {
                    var block = $scope.blocks[i];
                    promises.push(renderBlock(block));
                }
            }

            $scope.renderComplete = function () {
                if (promises.length) {
                    $.when(promises).then(function () {
                        promises = [];
                        $window.parent.postMessage({ type: 'render-complete' }, designerUrl);
                    });
                }
            };

            function renderBlock(block, callback) {
                return new Promise(function (resolve, reject) {
                    $http.post(getUrl("block"), block.source).then(function (result) {
                        block.result = $sce.trustAsHtml(result.data);
                        if (!!callback) {
                            callback(block);
                        }
                        resolve();
                    }).catch(function () {
                        reject();
                    });
                });
            }

            function createBlockModel(section) {
                return {
                    id: section.id,
                    source: section,
                    result: ''
                };
            }

            function findById(id) {
                for (var i = 0; i < $scope.blocks.length; i++) {
                    var block = $scope.blocks[i];
                    if (block.id == id)
                        return { block: block, index: i };
                }
                return null;
            }

        }]);
    })();
</script>

{% raw %}

<style>
    #preview-container .block-holder {
        padding: 3px;
    }

    #preview-container .block-holder:hover {
        border: 1px dotted #33ada9;
        box-sizing: border-box;
        padding: 2px;
    }

    #preview-container .block-holder.active {
        border: 3px solid #33ada9;
        box-sizing: border-box;
        padding: 0;
    }
</style>

<div class="grid" ng-controller="previewController">

    <div class="grid-item large--two-thirds push--large--one-sixth">

        <h1>{{ title }}</h1>

        <div id="preview-container">
            <div class="block-holder" ng-repeat="item in blocks track by item.id"
                 ng-bind-html="item.result"
                 id="block-{{ item.id }}"
                 ng-init="$last && renderComplete()"
                 ng-click="selectBlock(item)"></div>
        </div>

    </div>

</div>

{% endraw %}

